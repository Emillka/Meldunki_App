---
// Strona rejestracji z shadcn/ui
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Alert, AlertDescription } from '../components/ui/alert';
---

<Layout 
  title="Rejestracja" 
  description="Zarejestruj się w systemie FireLog, aby rozpocząć zarządzanie meldunkami swojej jednostki OSP."
  keywords="rejestracja, OSP, straż pożarna, meldunki, system, nowe konto"
>
  <div class="min-h-screen bg-background flex flex-col">
    <!-- Header -->
    <Header currentPath="/register" />
    
    <!-- Registration Section -->
    <section class="flex-1 flex items-center justify-center p-4 sm:p-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <span class="material-icons text-primary-foreground text-3xl">local_fire_department</span>
          </div>
          <CardTitle className="text-2xl">Rejestracja</CardTitle>
          <CardDescription>
            Utwórz nowe konto w systemie FireLog
          </CardDescription>
        </CardHeader>
        
        <CardContent>
          <!-- Message container -->
          <div id="message" class="hidden mb-6"></div>

          <!-- Registration Form -->
          <form id="registerForm" class="space-y-6">
            <!-- Email -->
            <div class="space-y-2">
              <Label htmlFor="email">Email</Label>
              <Input
                type="email"
                id="email"
                name="email"
                required
                placeholder="Wprowadź swój email"
              />
            </div>

            <!-- Password -->
            <div class="space-y-2">
              <Label htmlFor="password">Hasło</Label>
              <Input
                type="password"
                id="password"
                name="password"
                required
                placeholder="Wprowadź swoje hasło"
              />
              <p class="text-xs text-muted-foreground">
                Hasło musi zawierać: wielką i małą literę, cyfrę, znak specjalny
              </p>
            </div>

            <!-- First Name -->
            <div class="space-y-2">
              <Label htmlFor="firstName">Imię (opcjonalne)</Label>
              <Input
                type="text"
                id="firstName"
                name="firstName"
                placeholder="Wprowadź swoje imię"
              />
            </div>

            <!-- Last Name -->
            <div class="space-y-2">
              <Label htmlFor="lastName">Nazwisko (opcjonalne)</Label>
              <Input
                type="text"
                id="lastName"
                name="lastName"
                placeholder="Wprowadź swoje nazwisko"
              />
            </div>

            <!-- Fire Department Name -->
            <div class="space-y-2">
              <Label htmlFor="fireDepartmentName">Nazwa Jednostki OSP</Label>
              <select
                id="fireDepartmentName"
                name="fireDepartmentName"
                required
                class="flex h-10 w-full rounded-md border border-input bg-background px-3 py-2 text-sm ring-offset-background file:border-0 file:bg-transparent file:text-sm file:font-medium focus-visible:outline-none focus-visible:ring-2 focus-visible:ring-ring focus-visible:ring-offset-2 disabled:cursor-not-allowed disabled:opacity-50"
              >
                <option value="" disabled selected style="color: #6b7280;">Wybierz jednostkę OSP</option>
                <option value="OSP Test Warszawa">OSP Test Warszawa</option>
                <option value="OSP Ożarów Mazowiecki">OSP Ożarów Mazowiecki</option>
                <option value="OSP Błonie">OSP Błonie</option>
                <option value="OSP Wieliczka">OSP Wieliczka</option>
                <option value="OSP Niepołomice">OSP Niepołomice</option>
              </select>
              <p class="text-xs text-muted-foreground">
                Wybierz jednostkę Ochotniczej Straży Pożarnej z listy
              </p>
            </div>

            <!-- Submit Button -->
            <Button
              type="submit"
              id="submitBtn"
              className="w-full"
            >
              <span class="material-icons mr-2">person_add</span>
              Zarejestruj się
            </Button>
          </form>

          <!-- Links -->
          <div class="mt-8 text-center space-y-4">
            <p class="text-sm text-muted-foreground">
              Masz już konto? 
              <Button variant="link" asChild className="p-0 h-auto">
                <a href="/login">Zaloguj się</a>
              </Button>
            </p>
            <Button variant="link" asChild className="p-0 h-auto">
              <a href="/">← Powrót do strony głównej</a>
            </Button>
          </div>
        </CardContent>
      </Card>
    </section>

    <!-- Footer -->
    <Footer showBackToTop={false} />
  </div>
</Layout>

<style>
  /* M3 Text Field Focus Styles */
  .m3-text-field input:focus {
    outline: none;
    border-color: var(--md-sys-color-primary);
    border-width: 2px;
  }
  
  .m3-text-field input:focus + label,
  .m3-text-field input:not(:placeholder-shown) + label {
    top: 8px;
    font-size: 12px;
    color: var(--md-sys-color-primary);
  }
  
  /* Message styles */
  #message.success {
    background-color: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);
    border: 1px solid var(--md-sys-color-primary);
  }
  
  #message.error {
    background-color: var(--md-sys-color-error-container);
    color: var(--md-sys-color-on-error-container);
    border: 1px solid var(--md-sys-color-error);
  }
</style>

<script>
  const form = document.getElementById('registerForm') as HTMLFormElement;
  const messageDiv = document.getElementById('message') as HTMLDivElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  function showMessage(message: string, isError: boolean = false) {
    messageDiv.textContent = message;
    messageDiv.className = isError ? 'error' : 'success';
    messageDiv.style.display = 'block';
  }

  function hideMessage() {
    messageDiv.style.display = 'none';
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessage();

    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">hourglass_empty</span>Rejestrowanie...';

    // Get form data
    const formData = new FormData(form);
    const data = {
      email: formData.get('email') as string,
      password: formData.get('password') as string,
      fire_department_name: formData.get('fireDepartmentName') as string,
      first_name: formData.get('firstName') as string || undefined,
      last_name: formData.get('lastName') as string || undefined,
      role: 'member' as const
    };

    try {
      // Call the API endpoint
      const response = await fetch('/api/auth/register', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      });

      const result = await response.json();

      if (result.success) {
        // ✅ Success!
        showMessage('✅ Rejestracja udana! Przekierowuję...', false);
        
        // Store access token
        localStorage.setItem('access_token', result.data.session.access_token);
        localStorage.setItem('refresh_token', result.data.session.refresh_token);
        
        // Log user data
        console.log('Zarejestrowany użytkownik:', result.data.user);
        console.log('Profil:', result.data.profile);
        console.log('Token:', result.data.session.access_token.substring(0, 20) + '...');

        // Redirect after 2 seconds
        setTimeout(() => {
          window.location.href = '/';
        }, 2000);

      } else {
        // ❌ Error from API
        let errorMessage = result.error.message;
        
        // Show validation details if available
        if (result.error.details) {
          const details = Object.entries(result.error.details)
            .map(([field, msg]) => `${field}: ${msg}`)
            .join('\n');
          errorMessage += '\n\n' + details;
        }
        
        showMessage(`❌ ${errorMessage}`, true);
      }

    } catch (error) {
      // ❌ Network or other error
      console.error('Registration error:', error);
      showMessage('❌ Błąd połączenia. Sprawdź czy serwer działa.', true);
    } finally {
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">person_add</span>Zarejestruj się';
    }
  });
</script>