---
// Strona ustawiania nowego hasła
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Alert, AlertDescription } from '../components/ui/alert';
---

<Layout 
  title="Ustaw nowe hasło" 
  description="Ustaw nowe hasło do swojego konta FireLog"
  keywords="ustaw hasło, reset hasła, OSP, straż pożarna"
>
  <div class="min-h-screen bg-background flex flex-col">
    <!-- Header -->
    <Header currentPath="/reset-password" />
    
    <!-- Reset Password Section -->
    <section class="flex-1 flex items-center justify-center p-4 sm:p-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <span class="material-icons text-primary-foreground text-3xl">lock</span>
          </div>
          <CardTitle className="text-2xl">Ustaw nowe hasło</CardTitle>
          <CardDescription>
            Wprowadź nowe hasło dla swojego konta
          </CardDescription>
        </CardHeader>
        
        <CardContent>
          <!-- Message container -->
          <div id="message" class="hidden mb-6"></div>

          <!-- Reset Password Form -->
          <form id="resetPasswordForm" class="space-y-6">
            <!-- New Password -->
            <div class="space-y-2">
              <Label htmlFor="password">Nowe hasło</Label>
              <Input
                type="password"
                id="password"
                name="password"
                required
                autoComplete="new-password"
                placeholder="Wprowadź nowe hasło"
                minLength="8"
              />
              <p class="text-xs text-muted-foreground">
                Hasło musi zawierać min. 8 znaków, wielką literę, małą literę, cyfrę i znak specjalny
              </p>
            </div>

            <!-- Confirm Password -->
            <div class="space-y-2">
              <Label htmlFor="password_confirm">Powtórz nowe hasło</Label>
              <Input
                type="password"
                id="password_confirm"
                name="password_confirm"
                required
                autoComplete="new-password"
                placeholder="Powtórz nowe hasło"
                minLength="8"
              />
            </div>

            <!-- Submit Button -->
            <Button
              type="submit"
              id="submitBtn"
              className="w-full"
            >
              <span class="material-icons mr-2">check_circle</span>
              Ustaw nowe hasło
            </Button>
          </form>

          <!-- Links -->
          <div class="mt-8 text-center space-y-4">
            <Button variant="link" asChild className="p-0 h-auto">
              <a href="/login">← Powrót do logowania</a>
            </Button>
          </div>
        </CardContent>
      </Card>
    </section>

    <!-- Footer -->
    <Footer showBackToTop={false} />
  </div>
</Layout>

<style>
  /* Message styles */
  #message.success {
    background-color: var(--md-sys-color-primary-container);
    color: var(--md-sys-color-on-primary-container);
    border: 1px solid var(--md-sys-color-primary);
    padding: 1rem;
    border-radius: 0.5rem;
  }
  
  #message.error {
    background-color: var(--md-sys-color-error-container);
    color: var(--md-sys-color-on-error-container);
    border: 1px solid var(--md-sys-color-error);
    padding: 1rem;
    border-radius: 0.5rem;
  }
</style>

<script>
  const form = document.getElementById('resetPasswordForm') as HTMLFormElement;
  const messageDiv = document.getElementById('message') as HTMLDivElement;
  const submitBtn = document.getElementById('submitBtn') as HTMLButtonElement;

  function showMessage(message: string, isError: boolean = false) {
    messageDiv.textContent = message;
    messageDiv.className = isError ? 'error' : 'success';
    messageDiv.classList.remove('hidden');
    messageDiv.style.display = 'block';
  }

  function hideMessage() {
    messageDiv.style.display = 'none';
    messageDiv.classList.add('hidden');
  }

  // Password validation
  function validatePassword(password: string): { valid: boolean; errors: string[] } {
    const errors: string[] = [];
    
    if (password.length < 8) {
      errors.push('Hasło musi mieć minimum 8 znaków');
    }
    if (!/[A-Z]/.test(password)) {
      errors.push('Hasło musi zawierać wielką literę');
    }
    if (!/[a-z]/.test(password)) {
      errors.push('Hasło musi zawierać małą literę');
    }
    if (!/\d/.test(password)) {
      errors.push('Hasło musi zawierać cyfrę');
    }
    if (!/[!@#$%^&*(),.?":{}|<>]/.test(password)) {
      errors.push('Hasło musi zawierać znak specjalny');
    }
    
    return {
      valid: errors.length === 0,
      errors
    };
  }

  // Extract tokens from URL hash (Supabase sends tokens in hash)
  function extractTokensFromUrl(): { access_token: string | null; refresh_token: string | null } {
    const hash = window.location.hash.substring(1); // Remove #
    const params = new URLSearchParams(hash);
    
    const access_token = params.get('access_token');
    const refresh_token = params.get('refresh_token');
    
    return { access_token, refresh_token };
  }

  // Check if we have tokens on page load
  // In Astro, scripts run after DOM is ready, so we can check immediately
  const initialTokens = extractTokensFromUrl();
  if (!initialTokens.access_token || !initialTokens.refresh_token) {
    // Show message after a short delay to ensure DOM is ready
    setTimeout(() => {
      showMessage('❌ Brak tokenu resetowania hasła. Użyj linku z emaila.', true);
      // Disable form if no tokens
      form.querySelectorAll('input, button').forEach((el) => {
        (el as HTMLElement).setAttribute('disabled', 'true');
      });
    }, 100);
  }

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessage();

    // Get form data
    const formData = new FormData(form);
    const password = (formData.get('password') as string) || '';
    const password_confirm = (formData.get('password_confirm') as string) || '';

    // Validate passwords match
    if (password !== password_confirm) {
      showMessage('❌ Hasła nie są zgodne', true);
      return;
    }

    // Validate password strength
    const passwordValidation = validatePassword(password);
    if (!passwordValidation.valid) {
      showMessage(`❌ ${passwordValidation.errors.join(', ')}`, true);
      return;
    }

    // Get tokens from URL
    const tokens = extractTokensFromUrl();
    if (!tokens.access_token || !tokens.refresh_token) {
      showMessage('❌ Brak tokenu resetowania hasła. Użyj linku z emaila.', true);
      return;
    }

    // Disable button
    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-icons mr-2" style="font-size: 18px;">hourglass_empty</span>Zapisywanie...';

    try {
      // Call the API endpoint
      const response = await fetch('/api/auth/reset-password', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          password,
          password_confirm,
          access_token: tokens.access_token,
          refresh_token: tokens.refresh_token
        })
      });

      const result = await response.json();

      if (result.success) {
        // ✅ Success!
        showMessage('✅ Hasło zostało zmienione pomyślnie', false);
        // Clear form
        form.reset();
        
        // Redirect to login after 2-3 seconds
        setTimeout(() => {
          window.location.href = '/login';
        }, 2500);
      } else {
        // ❌ Error from API
        let errorMessage = result.error?.message || 'Wystąpił błąd. Spróbuj ponownie.';
        
        // Handle specific error types
        if (result.error?.code === 'INVALID_TOKEN') {
          errorMessage = 'Token resetowania hasła jest nieprawidłowy lub wygasł. Poproś o nowy link resetowania hasła.';
        }
        
        showMessage(`❌ ${errorMessage}`, true);
      }

    } catch (error) {
      // ❌ Network or other error
      console.error('Reset password error:', error);
      showMessage('❌ Błąd połączenia. Sprawdź czy serwer działa.', true);
    } finally {
      // Re-enable button
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="material-icons mr-2">check_circle</span>Ustaw nowe hasło';
    }
  });
</script>

