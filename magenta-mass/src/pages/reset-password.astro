---
// Strona resetowania has≈Ça - ustawienie nowego has≈Ça
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Alert, AlertDescription } from '../components/ui/alert';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<Layout 
  title="Ustaw nowe has≈Ço" 
  description="Ustaw nowe has≈Ço do swojego konta FireLog"
  keywords="resetowanie has≈Ça, nowe has≈Ço, OSP, stra≈º po≈ºarna"
>
  <div class="min-h-screen bg-background flex flex-col">
    <!-- Header -->
    <Header currentPath="/reset-password" />
    
    <!-- Reset Password Section -->
    <section class="flex-1 flex items-center justify-center p-4 sm:p-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <span class="material-icons text-primary-foreground text-3xl">lock</span>
          </div>
          <CardTitle className="text-2xl">Ustaw nowe has≈Ço</CardTitle>
          <CardDescription>
            Wprowad≈∫ nowe has≈Ço dla swojego konta
          </CardDescription>
        </CardHeader>
        
        <CardContent>
          <!-- Message container -->
          <Alert id="message" className="hidden mb-6">
            <AlertDescription id="messageText"></AlertDescription>
          </Alert>

          <!-- Info Alert -->
          <Alert className="mb-6">
            <AlertDescription>
              Has≈Ço musi zawieraƒá: wielkƒÖ i ma≈ÇƒÖ literƒô, cyfrƒô, znak specjalny oraz mieƒá co najmniej 8 znak√≥w.
            </AlertDescription>
          </Alert>

          <!-- Reset Password Form -->
          <form id="resetPasswordForm" method="POST" action="javascript:void(0);" class="space-y-6">
            <!-- Password -->
            <div class="space-y-2">
              <Label htmlFor="password">Nowe has≈Ço</Label>
              <Input
                type="password"
                id="password"
                name="password"
                required
                autoComplete="new-password"
                placeholder="Wprowad≈∫ nowe has≈Ço"
              />
              <p class="text-xs text-muted-foreground">
                Has≈Ço musi zawieraƒá: wielkƒÖ i ma≈ÇƒÖ literƒô, cyfrƒô, znak specjalny
              </p>
            </div>

            <!-- Confirm Password -->
            <div class="space-y-2">
              <Label htmlFor="confirmPassword">Potwierd≈∫ has≈Ço</Label>
              <Input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
                autoComplete="new-password"
                placeholder="Wprowad≈∫ has≈Ço ponownie"
              />
            </div>

            <!-- Submit Button -->
            <Button
              type="submit"
              id="submitBtn"
              className="w-full"
            >
              <span class="material-icons mr-2">check_circle</span>
              Ustaw nowe has≈Ço
            </Button>
          </form>

          <!-- Links -->
          <div class="mt-8 text-center space-y-4">
            <Button variant="link" asChild className="p-0 h-auto">
              <a href="/login">‚Üê Powr√≥t do logowania</a>
            </Button>
          </div>
        </CardContent>
      </Card>
    </section>

    <!-- Footer -->
    <Footer showBackToTop={false} />
  </div>
</Layout>

<script define:vars={{ supabaseUrl, supabaseAnonKey }}>
  // CRITICAL: Log immediately to verify script is loading
  console.log('üöÄ SCRIPT STARTED - Reset Password Page');
  console.log('Timestamp:', new Date().toISOString());
  console.log('Window location:', window.location.href);
  
  // Import Supabase client
  import { createClient } from '@supabase/supabase-js';
  console.log('‚úÖ Supabase import successful');

  // Create Supabase client immediately
  const supabase = createClient(supabaseUrl, supabaseAnonKey);
  console.log('‚úÖ Supabase client created');
  
  console.log('=== Reset Password Script Loading ===');
  console.log('Supabase URL:', supabaseUrl ? 'Set' : 'Missing');
  console.log('Supabase Key:', supabaseAnonKey ? 'Set' : 'Missing');

  // Wait for DOM to be ready
  function initResetPassword() {
    console.log('=== Initializing Reset Password ===');
    console.log('Document ready state:', document.readyState);
    console.log('Current URL:', window.location.href);
    
    // Try multiple times to find elements (React components may not be ready immediately)
    let form = document.getElementById('resetPasswordForm');
    let messageDiv = document.getElementById('message');
    let messageText = document.getElementById('messageText');
    let submitBtn = document.getElementById('submitBtn');
    
    // If elements not found, wait a bit and try again
    if (!form || !messageDiv || !messageText || !submitBtn) {
      console.log('‚ö†Ô∏è Some elements not found, waiting 500ms and retrying...');
      setTimeout(() => {
        form = document.getElementById('resetPasswordForm');
        messageDiv = document.getElementById('message');
        messageText = document.getElementById('messageText');
        submitBtn = document.getElementById('submitBtn');
        if (form && messageDiv && messageText && submitBtn) {
          console.log('‚úÖ All elements found on retry');
          setupFormHandlers(form, messageDiv, messageText, submitBtn);
        } else {
          console.error('‚ùå Elements still not found after retry:', {
            form: !!form,
            messageDiv: !!messageDiv,
            messageText: !!messageText,
            submitBtn: !!submitBtn
          });
        }
      }, 500);
      return;
    }
    
    console.log('‚úÖ All elements found immediately');
    setupFormHandlers(form, messageDiv, messageText, submitBtn);
  }
  
  // Shared variables and functions
  let recoverySessionSet = false;
  
  function showMessage(message, isError = false, messageDivEl = null, messageTextEl = null) {
    const msgDiv = messageDivEl || document.getElementById('message');
    const msgText = messageTextEl || document.getElementById('messageText');
    console.log('showMessage called:', { message, isError });
    if (msgText) {
      msgText.textContent = message;
      console.log('Message text set');
    } else {
      console.error('messageText element not found!');
    }
    if (msgDiv) {
      // Remove hidden class
      msgDiv.classList.remove('hidden');
      
      // Preserve base Alert classes and add appropriate variant classes
      msgDiv.className = 'relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground';
      
      if (isError) {
        msgDiv.classList.add('bg-destructive/10', 'text-destructive', 'border-destructive/50', 'dark:border-destructive');
      } else {
        msgDiv.classList.add('bg-green-50', 'text-green-800', 'border-green-300', 'dark:bg-green-900/20', 'dark:text-green-300');
      }
      
      msgDiv.style.display = 'block';
      console.log('Message div shown, classes:', msgDiv.className);
      
      // Scroll to message
      setTimeout(() => {
        msgDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 100);
    } else {
      console.error('messageDiv element not found!');
    }
  }

  function hideMessage(messageDivEl = null) {
    const msgDiv = messageDivEl || document.getElementById('message');
    if (msgDiv) {
      msgDiv.classList.add('hidden');
      msgDiv.style.display = 'none';
    }
  }
  
  async function initializePasswordReset() {
    try {
      console.log('=== Initializing Password Reset ===');
      console.log('Current URL:', window.location.href);
      console.log('URL hash:', window.location.hash);
      
      // First, check URL hash for recovery tokens (Supabase password reset flow)
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');
      const type = hashParams.get('type');
      const error = hashParams.get('error');
      const errorDescription = hashParams.get('error_description');
      
      console.log('URL hash params:', { 
        hasAccessToken: !!accessToken, 
        hasRefreshToken: !!refreshToken, 
        type,
        error,
        errorDescription,
        hashLength: window.location.hash.length
      });
      
      // Check for errors in URL
      if (error) {
        console.error('Error in URL hash:', error, errorDescription);
        const msgDiv = document.getElementById('message');
        const msgText = document.getElementById('messageText');
        showMessage(`‚ùå B≈ÇƒÖd w linku resetowania: ${errorDescription || error}`, true, msgDiv, msgText);
        return;
      }
      
      // If we have recovery tokens in URL, set them as session
      // Note: Supabase recovery links include type=recovery in the hash
      if (accessToken && refreshToken) {
        console.log('Found tokens in URL, setting recovery session...');
        console.log('Access token (first 20 chars):', accessToken.substring(0, 20) + '...');
        console.log('Refresh token (first 20 chars):', refreshToken.substring(0, 20) + '...');
        
        const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });
        
        if (sessionError) {
          console.error('‚ùå Error setting recovery session:', {
            message: sessionError.message,
            status: sessionError.status,
            name: sessionError.name,
            fullError: sessionError
          });
          const msgDiv = document.getElementById('message');
          const msgText = document.getElementById('messageText');
          showMessage('‚ùå Link resetowania has≈Ça jest nieprawid≈Çowy lub wygas≈Ç. Popro≈õ o nowy link.', true, msgDiv, msgText);
        } else if (sessionData.session) {
          console.log('‚úÖ Recovery session set successfully', { 
            userId: sessionData.user?.id,
            email: sessionData.user?.email,
            hasAccessToken: !!sessionData.session.access_token,
            expiresAt: new Date(sessionData.session.expires_at * 1000).toISOString()
          });
          recoverySessionSet = true;
          // Don't clear hash yet - we'll clear it after password is updated
        } else {
          console.error('‚ùå Session not set despite no error');
          console.log('Session data:', sessionData);
          const msgDiv = document.getElementById('message');
          const msgText = document.getElementById('messageText');
          showMessage('‚ùå Nie mo≈ºna ustawiƒá sesji resetowania. Spr√≥buj ponownie.', true, msgDiv, msgText);
        }
      } else {
        // Check if we already have a session (might have been set on page load)
        console.log('No tokens in URL hash, checking existing session...');
        const { data: existingSession, error: sessionCheckError } = await supabase.auth.getSession();
        
        if (sessionCheckError) {
          console.error('Error checking session:', sessionCheckError);
        }
        
        if (existingSession.session) {
          console.log('‚úÖ Existing session found', { 
            userId: existingSession.user?.id,
            email: existingSession.user?.email,
            hasAccessToken: !!existingSession.session.access_token
          });
          recoverySessionSet = true;
        } else {
          console.warn('‚ö†Ô∏è No session found and no tokens in URL');
          const msgDiv = document.getElementById('message');
          const msgText = document.getElementById('messageText');
          showMessage('‚ùå Brak tokena resetowania has≈Ça w URL. Upewnij siƒô, ≈ºe u≈ºywasz linku z emaila.', true, msgDiv, msgText);
        }
      }
      
      console.log('=== End Initialization ===');
      console.log('Recovery session set:', recoverySessionSet);
    } catch (err) {
      console.error('‚ùå Error initializing password reset:', err);
      const msgDiv = document.getElementById('message');
      const msgText = document.getElementById('messageText');
      showMessage('‚ùå B≈ÇƒÖd podczas inicjalizacji resetu has≈Ça. Spr√≥buj ponownie.', true, msgDiv, msgText);
    }
  }

  // Initialize on page load
  initializePasswordReset();
  
  function setupFormHandlers(form, messageDiv, messageText, submitBtn) {
    console.log('=== Setting up form handlers ===');
    
    // Async handler function - defined before event listener
    async function handleFormSubmit() {
      // Store reference globally so window listener can call it
      globalFormSubmitHandler = handleFormSubmit;
      console.log('üîµ handleFormSubmit called');
      
      hideMessage(messageDiv);

      const formData = new FormData(form);
      const password = formData.get('password');
      const confirmPassword = formData.get('confirmPassword');

    // Validate that passwords are strings and not empty
    if (!password || typeof password !== 'string' || password.trim().length === 0) {
      showMessage('‚ùå Has≈Ço jest wymagane', true);
      return;
    }

    if (!confirmPassword || typeof confirmPassword !== 'string' || confirmPassword.trim().length === 0) {
      showMessage('‚ùå Potwierdzenie has≈Ça jest wymagane', true);
      return;
    }

    // Trim passwords
    const passwordTrimmed = password.trim();
    const confirmPasswordTrimmed = confirmPassword.trim();

    if (passwordTrimmed !== confirmPasswordTrimmed) {
      showMessage('‚ùå Has≈Ça nie sƒÖ identyczne', true);
      return;
    }

    // Validate password strength with detailed error messages
    console.log('=== Password Validation ===');
    console.log('Password length:', passwordTrimmed.length);
    console.log('Password (first 3 chars):', passwordTrimmed.substring(0, 3) + '...');
    
    const errors = [];
    
    if (passwordTrimmed.length < 8) {
      errors.push('co najmniej 8 znak√≥w');
      console.log('‚ùå Length check failed:', passwordTrimmed.length, '< 8');
    } else {
      console.log('‚úÖ Length check passed:', passwordTrimmed.length);
    }
    
    const hasUpperCase = /[A-Z]/.test(passwordTrimmed);
    const hasLowerCase = /[a-z]/.test(passwordTrimmed);
    const hasNumber = /\d/.test(passwordTrimmed);
    // Expanded special character regex to include more characters
    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(passwordTrimmed);
    
    console.log('Has uppercase:', hasUpperCase);
    console.log('Has lowercase:', hasLowerCase);
    console.log('Has number:', hasNumber);
    console.log('Has special:', hasSpecial);
    
    if (!hasUpperCase) {
      errors.push('wielkƒÖ literƒô (A-Z)');
      console.log('‚ùå Uppercase check failed');
    } else {
      console.log('‚úÖ Uppercase check passed');
    }
    
    if (!hasLowerCase) {
      errors.push('ma≈ÇƒÖ literƒô (a-z)');
      console.log('‚ùå Lowercase check failed');
    } else {
      console.log('‚úÖ Lowercase check passed');
    }
    
    if (!hasNumber) {
      errors.push('cyfrƒô (0-9)');
      console.log('‚ùå Number check failed');
    } else {
      console.log('‚úÖ Number check passed');
    }
    
    if (!hasSpecial) {
      errors.push('znak specjalny (!@#$%^&*()_+-=[]{}|;:,.<>?)');
      console.log('‚ùå Special character check failed');
    } else {
      console.log('‚úÖ Special character check passed');
    }
    
    if (errors.length > 0) {
      const errorMessage = `‚ùå Has≈Ço musi zawieraƒá: ${errors.join(', ')}`;
      console.log('=== Validation FAILED ===');
      console.log('Errors:', errors);
      showMessage(errorMessage, true);
      return;
    }
    
    console.log('=== Validation PASSED ===');
    console.log('All password requirements met');

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">hourglass_empty</span>Resetowanie...';

    try {
      console.log('=== Form Submit - Starting Password Reset ===');
      console.log('Recovery session set:', recoverySessionSet);
      
      // Ensure we have a recovery session
      if (!recoverySessionSet) {
        console.log('Recovery session not set, trying to get from URL hash...');
        // Try to get from URL hash one more time
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        
        console.log('Tokens from URL:', {
          hasAccessToken: !!accessToken,
          hasRefreshToken: !!refreshToken,
          hashLength: window.location.hash.length
        });
        
        if (!accessToken || !refreshToken) {
          const errorMsg = 'Brak tokena resetowania has≈Ça w URL. Upewnij siƒô, ≈ºe u≈ºywasz linku z emaila.';
          console.error('‚ùå', errorMsg);
          console.log('Current URL:', window.location.href);
          throw new Error(errorMsg);
        }
        
        console.log('Setting session from URL tokens...');
        // Set session from URL tokens
        const { data: setSessionData, error: setSessionError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });
        
        if (setSessionError) {
          console.error('‚ùå Error setting session:', setSessionError);
          throw new Error(`Nie mo≈ºna ustawiƒá sesji z tokena: ${setSessionError.message}`);
        }
        
        if (!setSessionData.session) {
          console.error('‚ùå Session not set despite no error');
          throw new Error('Nie mo≈ºna ustawiƒá sesji z tokena. Link mo≈ºe byƒá nieprawid≈Çowy lub wygas≈Çy.');
        }
        
        console.log('‚úÖ Session set from URL tokens', {
          userId: setSessionData.user?.id,
          hasAccessToken: !!setSessionData.session.access_token
        });
        recoverySessionSet = true;
      }

      // Verify we have a valid session
      console.log('Verifying session...');
      const { data: currentSession, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('‚ùå Session error:', sessionError);
        throw new Error(`B≈ÇƒÖd sesji: ${sessionError.message}`);
      }
      
      if (!currentSession.session) {
        console.error('‚ùå No session found');
        throw new Error('Brak wa≈ºnej sesji resetowania has≈Ça. Upewnij siƒô, ≈ºe u≈ºywasz linku z emaila.');
      }
      
      if (!currentSession.session.access_token) {
        console.error('‚ùå No access token in session');
        throw new Error('Brak tokena dostƒôpu w sesji. Link mo≈ºe byƒá nieprawid≈Çowy lub wygas≈Çy.');
      }
      
      console.log('‚úÖ Session verified', {
        userId: currentSession.user?.id,
        email: currentSession.user?.email,
        hasAccessToken: !!currentSession.session.access_token,
        tokenExpiresAt: new Date(currentSession.session.expires_at * 1000).toISOString()
      });

      console.log('Updating password with recovery session...', { 
        userId: currentSession.user?.id,
        hasAccessToken: !!currentSession.session.access_token 
      });
      
      // Update password using Supabase client with recovery session
      // When updating password through a recovery session, Supabase automatically:
      // 1. Updates the password in the database
      // 2. Invalidates all other sessions for this user
      console.log('=== Attempting to update password ===');
      console.log('Password length:', passwordTrimmed.length);
      console.log('Session user ID:', currentSession.user?.id);
      console.log('Session email:', currentSession.user?.email);
      console.log('Has access token:', !!currentSession.session.access_token);
      console.log('Session type (recovery):', currentSession.session.user?.recovery_sent_at ? 'Yes' : 'No');
      
      // IMPORTANT: For password reset with recovery session, we need to ensure
      // the session is properly set as a recovery session before updating
      // Supabase requires the session to be a recovery session to update password
      
      console.log('Calling supabase.auth.updateUser with password...');
      const { data: updateData, error: updateError } = await supabase.auth.updateUser({
        password: passwordTrimmed
      });

      console.log('Update user response:', {
        hasData: !!updateData,
        hasError: !!updateError,
        hasUser: !!updateData?.user,
        errorMessage: updateError?.message,
        errorName: updateError?.name,
        errorStatus: updateError?.status
      });

      if (updateError) {
        const errorObj = updateError;
        const errorCode = errorObj.code || errorObj.status || '';
        const errorDetails = errorObj.details || '';
        
        console.error('‚ùå Password update ERROR:', {
          message: updateError.message,
          status: updateError.status,
          name: updateError.name,
          fullError: updateError,
          code: errorCode,
          details: errorDetails
        });
        
        const errorMessage = updateError.message || 'Nie uda≈Ço siƒô zresetowaƒá has≈Ça';
        
        // Check for specific Supabase error codes
        if (errorCode === 'invalid_credentials' || errorCode === 'invalid_token') {
          showMessage('‚ùå Link resetowania has≈Ça jest nieprawid≈Çowy lub wygas≈Ç. Popro≈õ o nowy link.', true);
        } else if (errorMessage.includes('session') || errorMessage.includes('token') || errorMessage.includes('expired') || errorMessage.includes('JWT') || errorMessage.includes('Invalid')) {
          showMessage('‚ùå Link resetowania has≈Ça jest nieprawid≈Çowy lub wygas≈Ç. Popro≈õ o nowy link.', true);
        } else if (errorMessage.includes('password') || errorMessage.includes('weak') || errorMessage.includes('strength')) {
          showMessage(`‚ùå ${errorMessage}. Upewnij siƒô, ≈ºe has≈Ço spe≈Çnia wszystkie wymagania.`, true);
        } else {
          showMessage(`‚ùå ${errorMessage}`, true);
        }
        
        // Re-enable button on error
        if (submitBtn) {
          submitBtn.disabled = false;
          submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">check_circle</span>Ustaw nowe has≈Ço';
        }
        return;
      }
      
      console.log('‚úÖ Password update API call successful!', {
        userId: updateData?.user?.id,
        email: updateData?.user?.email,
        hasUser: !!updateData?.user
      });

      // Verify password was actually updated by checking user data
      if (!updateData.user) {
        console.error('‚ùå Password update failed - no user in response:', updateData);
        throw new Error('Has≈Ço nie zosta≈Ço zaktualizowane. Spr√≥buj ponownie.');
      }

      console.log('‚úÖ User data in response:', {
        userId: updateData.user.id,
        email: updateData.user.email,
        updatedAt: updateData.user.updated_at
      });
      
      // Sign out to clear the recovery session and ensure clean state
      // This also helps invalidate any cached sessions
      console.log('Signing out recovery session...');
      const { error: signOutError } = await supabase.auth.signOut();
      if (signOutError) {
        console.warn('Sign out warning (non-critical):', signOutError);
        // Continue anyway - password was updated
      }
      
      // Clear URL hash to remove tokens IMMEDIATELY to prevent reusing the link
      console.log('Clearing URL hash and tokens...');
      window.history.replaceState(null, '', window.location.pathname);
      
      // Clear all Supabase auth data from localStorage
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('supabase') || key.includes('auth') || key.includes('token'))) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // DISABLE form to prevent resubmission
      if (form) {
        form.style.pointerEvents = 'none';
        form.style.opacity = '0.6';
      }
      if (submitBtn) {
        submitBtn.disabled = true;
      }
      
      // Show success message - make sure it's visible and prominent
      console.log('‚úÖ Password reset successful! Showing success message...');
      const successMessage = '‚úÖ Has≈Ço zosta≈Ço pomy≈õlnie zmienione! Mo≈ºesz siƒô teraz zalogowaƒá u≈ºywajƒÖc nowego has≈Ça. Przekierowywanie do strony logowania...';
      
      // Reset form (but it's disabled so user can't resubmit)
      form.reset();
      
      // Show message immediately
      console.log('Showing success message...');
      showMessage(successMessage, false);
      
      // Scroll to message to ensure user sees it
      const messageDivElement = document.getElementById('message');
      if (messageDivElement) {
        console.log('Message div found, scrolling into view...');
        // Force immediate visibility
        messageDivElement.style.display = 'block';
        messageDivElement.style.visibility = 'visible';
        messageDivElement.style.opacity = '1';
        messageDivElement.style.position = 'relative';
        messageDivElement.style.zIndex = '9999';
        
        setTimeout(() => {
          messageDivElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
          // Make message more prominent
          messageDivElement.style.fontSize = '16px';
          messageDivElement.style.padding = '1.5rem';
          messageDivElement.style.fontWeight = '500';
          messageDivElement.style.marginBottom = '1rem';
          console.log('Message scrolled and styled');
        }, 100);
      } else {
        console.error('‚ùå Message div element not found after password reset!');
      }
      
      // Redirect to login with success message after a longer delay (give user time to see message)
      console.log('Will redirect to login page in 5 seconds...');
      setTimeout(() => {
        console.log('Redirecting to login page...');
        window.location.href = '/login?passwordReset=success';
      }, 5000);

    } catch (error) {
      console.error('Reset password error:', error);
      const errorMessage = error instanceof Error ? error.message : 'Nieznany b≈ÇƒÖd';
      console.log('Showing error message:', errorMessage);
      showMessage(`‚ùå ${errorMessage}`, true);
      
      // Ensure error message is visible
      setTimeout(() => {
        const messageDivElement = document.getElementById('message');
        if (messageDivElement) {
          messageDivElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }
      }, 200);
    } finally {
      // Only re-enable button if there was an error (success case already disabled it)
      const messageDivElement = document.getElementById('message');
      if (messageDivElement && messageDivElement.classList.contains('hidden')) {
        submitBtn.disabled = false;
        submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">check_circle</span>Ustaw nowe has≈Ço';
      }
    }
    } // End of handleFormSubmit function
    
    // CRITICAL: Add event listener to handle form submission
    // This prevents default form submission and handles password reset
    console.log('Adding submit event listener to form...');
    
    // Use async function to properly await handleFormSubmit
    form.addEventListener('submit', async function(e) {
      // CRITICAL: Prevent default form submission immediately
      // This prevents passwords from being added to URL
      console.log('üîµ Form submit event triggered!');
      console.log('Event details:', {
        type: e.type,
        target: e.target,
        currentTarget: e.currentTarget,
        defaultPrevented: e.defaultPrevented
      });
      
      e.preventDefault();
      e.stopPropagation();
      
      console.log('‚úÖ Default prevented, calling handleFormSubmit...');
      
      // Call async handler and await it to properly catch errors
      try {
        await handleFormSubmit();
        console.log('‚úÖ handleFormSubmit completed');
      } catch (error) {
        console.error('‚ùå Unhandled error in form submit:', error);
        console.error('Error stack:', error instanceof Error ? error.stack : 'No stack');
        showMessage(`‚ùå WystƒÖpi≈Ç nieoczekiwany b≈ÇƒÖd: ${error instanceof Error ? error.message : 'Nieznany b≈ÇƒÖd'}`, true);
      }
    }, false); // Use capture: false (bubbling phase)
    
    // Also add click handler to button as backup
    if (submitBtn) {
      submitBtn.addEventListener('click', function(e) {
        console.log('üîµ Submit button clicked!');
        // Don't prevent default here - let form submit handle it
      });
    }
    
    console.log('‚úÖ Event listener added successfully');
    
    // Test if button is clickable
    console.log('Button element:', submitBtn);
    console.log('Button type:', submitBtn.type);
    console.log('Button disabled:', submitBtn.disabled);
    console.log('Form element:', form);
    
    // Force test click handler
    submitBtn.addEventListener('click', function(e) {
      console.log('üîµ DIRECT BUTTON CLICK HANDLER TRIGGERED!');
      console.log('Event:', e);
      console.log('Button:', this);
      // Trigger form submit programmatically
      if (form) {
        console.log('Triggering form submit...');
        form.requestSubmit();
      }
    }, true); // Use capture phase
    
    console.log('‚úÖ All handlers set up successfully');
  } // End of setupFormHandlers function
  
  // CRITICAL: Add immediate form submit listener that works regardless of React
  console.log('üîß Setting up IMMEDIATE form listener...');
  
  // Global handler function that can be called from anywhere
  let globalFormSubmitHandler = null;
  
  // Use window-level event delegation for form submit
  window.addEventListener('submit', function(e) {
    const target = e.target;
    if (target && (target.id === 'resetPasswordForm' || target.closest && target.closest('#resetPasswordForm'))) {
      console.log('üéØ FORM SUBMIT DETECTED via window listener!');
      console.log('Event:', e);
      console.log('Target:', target);
      e.preventDefault();
      e.stopPropagation();
      
      // If we have a global handler, use it
      if (globalFormSubmitHandler) {
        console.log('‚úÖ Calling global form submit handler...');
        globalFormSubmitHandler();
      } else {
        console.warn('‚ö†Ô∏è Global handler not set yet, trying to set it up...');
        // Try to set up handlers now
        const form = document.getElementById('resetPasswordForm');
        const messageDiv = document.getElementById('message');
        const messageText = document.getElementById('messageText');
        const submitBtn = document.getElementById('submitBtn');
        
        if (form && messageDiv && messageText && submitBtn) {
          console.log('‚úÖ All elements found, setting up handlers...');
          setupFormHandlers(form, messageDiv, messageText, submitBtn);
          // Try to trigger submit again after setup
          setTimeout(() => {
            if (globalFormSubmitHandler) {
              globalFormSubmitHandler();
            }
          }, 100);
        } else {
          console.error('‚ùå Elements not found:', {
            form: !!form,
            messageDiv: !!messageDiv,
            messageText: !!messageText,
            submitBtn: !!submitBtn
          });
        }
      }
    }
  }, true); // Use capture phase
  
  console.log('‚úÖ Window-level form listener added');
  
  // Also add click listener on window level
  window.addEventListener('click', function(e) {
    const target = e.target;
    // Check if clicked element is inside submit button
    if (target && (target.id === 'submitBtn' || target.closest('#submitBtn') || target.closest('button[type="submit"]'))) {
      console.log('üéØ BUTTON CLICK DETECTED via window listener!');
      console.log('Target:', target);
      console.log('Button element:', target.closest('button') || target);
      
      const form = document.getElementById('resetPasswordForm');
      if (form) {
        console.log('‚úÖ Form found, triggering submit...');
        form.requestSubmit();
      }
    }
  }, true); // Use capture phase
  
  console.log('‚úÖ Window-level click listener added');
  
  // Initialize when DOM is ready
  console.log('Document ready state:', document.readyState);
  if (document.readyState === 'loading') {
    console.log('üìã Waiting for DOMContentLoaded...');
    document.addEventListener('DOMContentLoaded', function() {
      console.log('‚úÖ DOMContentLoaded fired');
      initResetPassword();
    });
  } else {
    console.log('‚úÖ DOM already ready, calling initResetPassword immediately');
    // DOM is already ready
    initResetPassword();
  }
  
  console.log('üöÄ Script initialization complete');
</script>
