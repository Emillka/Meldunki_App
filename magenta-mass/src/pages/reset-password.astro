---
// Strona resetowania hasła - ustawienie nowego hasła
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Alert, AlertDescription } from '../components/ui/alert';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<Layout 
  title="Ustaw nowe hasło" 
  description="Ustaw nowe hasło do swojego konta FireLog"
  keywords="resetowanie hasła, nowe hasło, OSP, straż pożarna"
>
  <div class="min-h-screen bg-background flex flex-col">
    <!-- Header -->
    <Header currentPath="/reset-password" />
    
    <!-- Reset Password Section -->
    <section class="flex-1 flex items-center justify-center p-4 sm:p-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <span class="material-icons text-primary-foreground text-3xl">lock</span>
          </div>
          <CardTitle className="text-2xl">Ustaw nowe hasło</CardTitle>
          <CardDescription>
            Wprowadź nowe hasło dla swojego konta
          </CardDescription>
        </CardHeader>
        
        <CardContent>
          <!-- Message container -->
          <Alert id="message" className="hidden mb-6">
            <AlertDescription id="messageText"></AlertDescription>
          </Alert>

          <!-- Info Alert -->
          <Alert className="mb-6">
            <AlertDescription>
              Hasło musi zawierać: wielką i małą literę, cyfrę, znak specjalny oraz mieć co najmniej 8 znaków.
            </AlertDescription>
          </Alert>

          <!-- Reset Password Form -->
          <form id="resetPasswordForm" class="space-y-6">
            <!-- Password -->
            <div class="space-y-2">
              <Label htmlFor="password">Nowe hasło</Label>
              <Input
                type="password"
                id="password"
                name="password"
                required
                autoComplete="new-password"
                placeholder="Wprowadź nowe hasło"
              />
              <p class="text-xs text-muted-foreground">
                Hasło musi zawierać: wielką i małą literę, cyfrę, znak specjalny
              </p>
            </div>

            <!-- Confirm Password -->
            <div class="space-y-2">
              <Label htmlFor="confirmPassword">Potwierdź hasło</Label>
              <Input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
                autoComplete="new-password"
                placeholder="Wprowadź hasło ponownie"
              />
            </div>

            <!-- Submit Button -->
            <Button
              type="submit"
              id="submitBtn"
              className="w-full"
            >
              <span class="material-icons mr-2">check_circle</span>
              Ustaw nowe hasło
            </Button>
          </form>

          <!-- Links -->
          <div class="mt-8 text-center space-y-4">
            <Button variant="link" asChild className="p-0 h-auto">
              <a href="/login">← Powrót do logowania</a>
            </Button>
          </div>
        </CardContent>
      </Card>
    </section>

    <!-- Footer -->
    <Footer showBackToTop={false} />
  </div>
</Layout>

<script define:vars={{ supabaseUrl, supabaseAnonKey }}>
  import { createClient } from '@supabase/supabase-js';

  const form = document.getElementById('resetPasswordForm');
  const messageDiv = document.getElementById('message');
  const messageText = document.getElementById('messageText');
  const submitBtn = document.getElementById('submitBtn');

  // Create Supabase client
  const supabase = createClient(supabaseUrl, supabaseAnonKey);

  function showMessage(message, isError = false) {
    if (messageText) {
      messageText.textContent = message;
    }
    if (messageDiv) {
      messageDiv.classList.remove('hidden');
      messageDiv.className = isError ? 'bg-destructive/10 text-destructive border-destructive' : 'bg-green-50 text-green-800 border-green-300';
      messageDiv.style.display = 'block';
      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function hideMessage() {
    if (messageDiv) {
      messageDiv.classList.add('hidden');
      messageDiv.style.display = 'none';
    }
  }

  // Check if we need to exchange token from URL hash to session
  // Supabase adds tokens in URL hash when user clicks reset link
  let recoverySessionSet = false;
  
  async function initializePasswordReset() {
    try {
      // First, check URL hash for recovery tokens (Supabase password reset flow)
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');
      const type = hashParams.get('type');
      
      console.log('URL hash params:', { hasAccessToken: !!accessToken, hasRefreshToken: !!refreshToken, type });
      
      // If we have recovery tokens in URL, set them as session
      // Note: Supabase recovery links include type=recovery in the hash
      if (accessToken && refreshToken) {
        console.log('Setting recovery session from URL hash...');
        const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });
        
        if (sessionError) {
          console.error('Error setting recovery session:', sessionError);
          showMessage('❌ Link resetowania hasła jest nieprawidłowy lub wygasł. Poproś o nowy link.', true);
        } else if (sessionData.session) {
          console.log('Recovery session set successfully', { userId: sessionData.user?.id });
          recoverySessionSet = true;
          // Don't clear hash yet - we'll clear it after password is updated
        } else {
          console.error('Session not set despite no error');
          showMessage('❌ Nie można ustawić sesji resetowania. Spróbuj ponownie.', true);
        }
      } else {
        // Check if we already have a session (might have been set on page load)
        const { data: existingSession } = await supabase.auth.getSession();
        if (existingSession.session) {
          console.log('Existing session found', { userId: existingSession.user?.id });
          recoverySessionSet = true;
        } else {
          showMessage('❌ Brak tokena resetowania hasła w URL. Upewnij się, że używasz linku z emaila.', true);
        }
      }
    } catch (err) {
      console.error('Error initializing password reset:', err);
      showMessage('❌ Błąd podczas inicjalizacji resetu hasła. Spróbuj ponownie.', true);
    }
  }

  // Initialize on page load
  initializePasswordReset();

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    hideMessage();

    const formData = new FormData(form);
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');

    if (password !== confirmPassword) {
      showMessage('❌ Hasła nie są identyczne', true);
      return;
    }

    if (password.length < 8) {
      showMessage('❌ Hasło musi mieć co najmniej 8 znaków', true);
      return;
    }

    const hasUpperCase = /[A-Z]/.test(password);
    const hasLowerCase = /[a-z]/.test(password);
    const hasNumber = /\d/.test(password);
    const hasSpecial = /[!@#$%^&*(),.?":{}|<>]/.test(password);

    if (!hasUpperCase || !hasLowerCase || !hasNumber || !hasSpecial) {
      showMessage('❌ Hasło musi zawierać: wielką i małą literę, cyfrę oraz znak specjalny', true);
      return;
    }

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">hourglass_empty</span>Resetowanie...';

    try {
      // Ensure we have a recovery session
      if (!recoverySessionSet) {
        // Try to get from URL hash one more time
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        
        if (!accessToken || !refreshToken) {
          throw new Error('Brak tokena resetowania hasła w URL. Upewnij się, że używasz linku z emaila.');
        }
        
        // Set session from URL tokens
        const { data: setSessionData, error: setSessionError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });
        
        if (setSessionError || !setSessionData.session) {
          throw new Error('Nie można ustawić sesji z tokena. Link może być nieprawidłowy lub wygasły.');
        }
        
        recoverySessionSet = true;
      }

      // Verify we have a valid session
      const { data: currentSession, error: sessionError } = await supabase.auth.getSession();
      if (sessionError || !currentSession.session?.access_token) {
        throw new Error('Brak ważnej sesji resetowania hasła. Upewnij się, że używasz linku z emaila.');
      }

      console.log('Updating password with recovery session...', { 
        userId: currentSession.user?.id,
        hasAccessToken: !!currentSession.session.access_token 
      });
      
      // Update password using Supabase client with recovery session
      // When updating password through a recovery session, Supabase automatically:
      // 1. Updates the password in the database
      // 2. Invalidates all other sessions for this user
      const { data: updateData, error: updateError } = await supabase.auth.updateUser({
        password: password
      });

      if (updateError) {
        console.error('Password reset error:', updateError);
        const errorMessage = updateError.message || 'Nie udało się zresetować hasła';
        if (errorMessage.includes('session') || errorMessage.includes('token') || errorMessage.includes('expired') || errorMessage.includes('JWT') || errorMessage.includes('Invalid')) {
          showMessage('❌ Link resetowania hasła jest nieprawidłowy lub wygasł. Poproś o nowy link.', true);
        } else {
          showMessage(`❌ ${errorMessage}`, true);
        }
        return;
      }

      // Verify password was actually updated by checking user data
      if (!updateData.user) {
        console.error('Password update failed - no user in response:', updateData);
        throw new Error('Hasło nie zostało zaktualizowane. Spróbuj ponownie.');
      }

      console.log('Password updated successfully', {
        userId: updateData.user.id,
        email: updateData.user.email,
        updatedAt: updateData.user.updated_at
      });
      
      // Double-check: verify the session is still valid after password update
      const { data: verifySession } = await supabase.auth.getSession();
      if (!verifySession.session) {
        console.warn('Session lost after password update - this is expected for recovery sessions');
      }
      
      // Sign out to clear the recovery session and ensure clean state
      // This also helps invalidate any cached sessions
      const { error: signOutError } = await supabase.auth.signOut();
      if (signOutError) {
        console.warn('Sign out warning (non-critical):', signOutError);
        // Continue anyway - password was updated
      }
      
      // Clear URL hash to remove tokens
      window.history.replaceState(null, '', window.location.pathname);
      
      // Clear all Supabase auth data from localStorage
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('supabase') || key.includes('auth') || key.includes('token'))) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // Show success message
      showMessage('✅ Hasło zostało pomyślnie zmienione! Przekierowywanie do strony logowania...', false);
      form.reset();
      
      // Redirect to login with success message after a short delay
      setTimeout(() => {
        window.location.href = '/login?passwordReset=success';
      }, 2000);

    } catch (error) {
      console.error('Reset password error:', error);
      const errorMessage = error instanceof Error ? error.message : 'Nieznany błąd';
      showMessage(`❌ ${errorMessage}`, true);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">check_circle</span>Ustaw nowe hasło';
    }
  });
</script>
