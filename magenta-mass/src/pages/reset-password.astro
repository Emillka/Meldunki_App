---
// Strona resetowania hasła - ustawienie nowego hasła
import Layout from '../layouts/Layout.astro';
import Header from '../components/Header.astro';
import Footer from '../components/Footer.astro';
import { Button } from '../components/ui/button';
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from '../components/ui/card';
import { Input } from '../components/ui/input';
import { Label } from '../components/ui/label';
import { Alert, AlertDescription } from '../components/ui/alert';

const supabaseUrl = import.meta.env.PUBLIC_SUPABASE_URL;
const supabaseAnonKey = import.meta.env.PUBLIC_SUPABASE_ANON_KEY;
---

<Layout 
  title="Ustaw nowe hasło" 
  description="Ustaw nowe hasło do swojego konta FireLog"
  keywords="resetowanie hasła, nowe hasło, OSP, straż pożarna"
>
  <div class="min-h-screen bg-background flex flex-col">
    <!-- Header -->
    <Header currentPath="/reset-password" />
    
    <!-- Reset Password Section -->
    <section class="flex-1 flex items-center justify-center p-4 sm:p-8">
      <Card className="w-full max-w-md">
        <CardHeader className="text-center">
          <div class="w-16 h-16 bg-primary rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg">
            <span class="material-icons text-primary-foreground text-3xl">lock</span>
          </div>
          <CardTitle className="text-2xl">Ustaw nowe hasło</CardTitle>
          <CardDescription>
            Wprowadź nowe hasło dla swojego konta
          </CardDescription>
        </CardHeader>
        
        <CardContent>
          <!-- Message container -->
          <Alert id="message" className="hidden mb-6">
            <AlertDescription id="messageText"></AlertDescription>
          </Alert>

          <!-- Info Alert -->
          <Alert className="mb-6">
            <AlertDescription>
              Hasło musi zawierać: wielką i małą literę, cyfrę, znak specjalny oraz mieć co najmniej 8 znaków.
            </AlertDescription>
          </Alert>

          <!-- Reset Password Form -->
          <form id="resetPasswordForm" method="POST" action="javascript:void(0);" class="space-y-6">
            <!-- Password -->
            <div class="space-y-2">
              <Label htmlFor="password">Nowe hasło</Label>
              <Input
                type="password"
                id="password"
                name="password"
                required
                autoComplete="new-password"
                placeholder="Wprowadź nowe hasło"
              />
              <p class="text-xs text-muted-foreground">
                Hasło musi zawierać: wielką i małą literę, cyfrę, znak specjalny
              </p>
            </div>

            <!-- Confirm Password -->
            <div class="space-y-2">
              <Label htmlFor="confirmPassword">Potwierdź hasło</Label>
              <Input
                type="password"
                id="confirmPassword"
                name="confirmPassword"
                required
                autoComplete="new-password"
                placeholder="Wprowadź hasło ponownie"
              />
            </div>

            <!-- Submit Button -->
            <Button
              type="submit"
              id="submitBtn"
              className="w-full"
            >
              <span class="material-icons mr-2">check_circle</span>
              Ustaw nowe hasło
            </Button>
          </form>

          <!-- Links -->
          <div class="mt-8 text-center space-y-4">
            <Button variant="link" asChild className="p-0 h-auto">
              <a href="/login">← Powrót do logowania</a>
            </Button>
          </div>
        </CardContent>
      </Card>
    </section>

    <!-- Footer -->
    <Footer showBackToTop={false} />
  </div>
</Layout>

<script define:vars={{ supabaseUrl, supabaseAnonKey }}>
  import { createClient } from '@supabase/supabase-js';

  // Wait for DOM to be ready
  function initResetPassword() {
    console.log('=== Initializing Reset Password Script ===');
    
    const form = document.getElementById('resetPasswordForm');
    const messageDiv = document.getElementById('message');
    const messageText = document.getElementById('messageText');
    const submitBtn = document.getElementById('submitBtn');

    // Check if form exists and log
    if (!form) {
      console.error('❌ Form not found!');
      return;
    } else {
      console.log('✅ Form found:', form.id);
    }
    
    // Check if other elements exist
    if (!messageDiv) {
      console.error('❌ Message div not found!');
    } else {
      console.log('✅ Message div found');
    }
    if (!messageText) {
      console.error('❌ Message text not found!');
    } else {
      console.log('✅ Message text found');
    }
    if (!submitBtn) {
      console.error('❌ Submit button not found!');
      return;
    } else {
      console.log('✅ Submit button found');
    }

    // Create Supabase client
    const supabase = createClient(supabaseUrl, supabaseAnonKey);

  function showMessage(message, isError = false) {
    if (messageText) {
      messageText.textContent = message;
    }
    if (messageDiv) {
      messageDiv.classList.remove('hidden');
      messageDiv.className = isError ? 'bg-destructive/10 text-destructive border-destructive' : 'bg-green-50 text-green-800 border-green-300';
      messageDiv.style.display = 'block';
      // Scroll to message
      messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
    }
  }

  function hideMessage() {
    if (messageDiv) {
      messageDiv.classList.add('hidden');
      messageDiv.style.display = 'none';
    }
  }

  // Check if we need to exchange token from URL hash to session
  // Supabase adds tokens in URL hash when user clicks reset link
  let recoverySessionSet = false;
  
  async function initializePasswordReset() {
    try {
      console.log('=== Initializing Password Reset ===');
      console.log('Current URL:', window.location.href);
      console.log('URL hash:', window.location.hash);
      
      // First, check URL hash for recovery tokens (Supabase password reset flow)
      const hashParams = new URLSearchParams(window.location.hash.substring(1));
      const accessToken = hashParams.get('access_token');
      const refreshToken = hashParams.get('refresh_token');
      const type = hashParams.get('type');
      const error = hashParams.get('error');
      const errorDescription = hashParams.get('error_description');
      
      console.log('URL hash params:', { 
        hasAccessToken: !!accessToken, 
        hasRefreshToken: !!refreshToken, 
        type,
        error,
        errorDescription,
        hashLength: window.location.hash.length
      });
      
      // Check for errors in URL
      if (error) {
        console.error('Error in URL hash:', error, errorDescription);
        showMessage(`❌ Błąd w linku resetowania: ${errorDescription || error}`, true);
        return;
      }
      
      // If we have recovery tokens in URL, set them as session
      // Note: Supabase recovery links include type=recovery in the hash
      if (accessToken && refreshToken) {
        console.log('Found tokens in URL, setting recovery session...');
        console.log('Access token (first 20 chars):', accessToken.substring(0, 20) + '...');
        console.log('Refresh token (first 20 chars):', refreshToken.substring(0, 20) + '...');
        
        const { data: sessionData, error: sessionError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });
        
        if (sessionError) {
          console.error('❌ Error setting recovery session:', {
            message: sessionError.message,
            status: sessionError.status,
            name: sessionError.name,
            fullError: sessionError
          });
          showMessage('❌ Link resetowania hasła jest nieprawidłowy lub wygasł. Poproś o nowy link.', true);
        } else if (sessionData.session) {
          console.log('✅ Recovery session set successfully', { 
            userId: sessionData.user?.id,
            email: sessionData.user?.email,
            hasAccessToken: !!sessionData.session.access_token,
            expiresAt: new Date(sessionData.session.expires_at * 1000).toISOString()
          });
          recoverySessionSet = true;
          // Don't clear hash yet - we'll clear it after password is updated
        } else {
          console.error('❌ Session not set despite no error');
          console.log('Session data:', sessionData);
          showMessage('❌ Nie można ustawić sesji resetowania. Spróbuj ponownie.', true);
        }
      } else {
        // Check if we already have a session (might have been set on page load)
        console.log('No tokens in URL hash, checking existing session...');
        const { data: existingSession, error: sessionCheckError } = await supabase.auth.getSession();
        
        if (sessionCheckError) {
          console.error('Error checking session:', sessionCheckError);
        }
        
        if (existingSession.session) {
          console.log('✅ Existing session found', { 
            userId: existingSession.user?.id,
            email: existingSession.user?.email,
            hasAccessToken: !!existingSession.session.access_token
          });
          recoverySessionSet = true;
        } else {
          console.warn('⚠️ No session found and no tokens in URL');
          showMessage('❌ Brak tokena resetowania hasła w URL. Upewnij się, że używasz linku z emaila.', true);
        }
      }
      
      console.log('=== End Initialization ===');
      console.log('Recovery session set:', recoverySessionSet);
    } catch (err) {
      console.error('❌ Error initializing password reset:', err);
      showMessage('❌ Błąd podczas inicjalizacji resetu hasła. Spróbuj ponownie.', true);
    }
  }

  // Initialize on page load
  initializePasswordReset();

  // CRITICAL: Add event listener to handle form submission
  // This prevents default form submission and handles password reset
  if (form) {
    console.log('Form found, adding submit event listener...');
    form.addEventListener('submit', async function(e) {
    // CRITICAL: Prevent default form submission immediately
    // This prevents passwords from being added to URL
    console.log('Form submit event triggered!');
    e.preventDefault();
    e.stopPropagation();
    
    hideMessage();

    const formData = new FormData(form);
    const password = formData.get('password');
    const confirmPassword = formData.get('confirmPassword');

    // Validate that passwords are strings and not empty
    if (!password || typeof password !== 'string' || password.trim().length === 0) {
      showMessage('❌ Hasło jest wymagane', true);
      return;
    }

    if (!confirmPassword || typeof confirmPassword !== 'string' || confirmPassword.trim().length === 0) {
      showMessage('❌ Potwierdzenie hasła jest wymagane', true);
      return;
    }

    // Trim passwords
    const passwordTrimmed = password.trim();
    const confirmPasswordTrimmed = confirmPassword.trim();

    if (passwordTrimmed !== confirmPasswordTrimmed) {
      showMessage('❌ Hasła nie są identyczne', true);
      return;
    }

    // Validate password strength with detailed error messages
    console.log('=== Password Validation ===');
    console.log('Password length:', passwordTrimmed.length);
    console.log('Password (first 3 chars):', passwordTrimmed.substring(0, 3) + '...');
    
    const errors = [];
    
    if (passwordTrimmed.length < 8) {
      errors.push('co najmniej 8 znaków');
      console.log('❌ Length check failed:', passwordTrimmed.length, '< 8');
    } else {
      console.log('✅ Length check passed:', passwordTrimmed.length);
    }
    
    const hasUpperCase = /[A-Z]/.test(passwordTrimmed);
    const hasLowerCase = /[a-z]/.test(passwordTrimmed);
    const hasNumber = /\d/.test(passwordTrimmed);
    // Expanded special character regex to include more characters
    const hasSpecial = /[!@#$%^&*()_+\-=\[\]{};':"\\|,.<>\/?]/.test(passwordTrimmed);
    
    console.log('Has uppercase:', hasUpperCase);
    console.log('Has lowercase:', hasLowerCase);
    console.log('Has number:', hasNumber);
    console.log('Has special:', hasSpecial);
    
    if (!hasUpperCase) {
      errors.push('wielką literę (A-Z)');
      console.log('❌ Uppercase check failed');
    } else {
      console.log('✅ Uppercase check passed');
    }
    
    if (!hasLowerCase) {
      errors.push('małą literę (a-z)');
      console.log('❌ Lowercase check failed');
    } else {
      console.log('✅ Lowercase check passed');
    }
    
    if (!hasNumber) {
      errors.push('cyfrę (0-9)');
      console.log('❌ Number check failed');
    } else {
      console.log('✅ Number check passed');
    }
    
    if (!hasSpecial) {
      errors.push('znak specjalny (!@#$%^&*()_+-=[]{}|;:,.<>?)');
      console.log('❌ Special character check failed');
    } else {
      console.log('✅ Special character check passed');
    }
    
    if (errors.length > 0) {
      const errorMessage = `❌ Hasło musi zawierać: ${errors.join(', ')}`;
      console.log('=== Validation FAILED ===');
      console.log('Errors:', errors);
      showMessage(errorMessage, true);
      return;
    }
    
    console.log('=== Validation PASSED ===');
    console.log('All password requirements met');

    submitBtn.disabled = true;
    submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">hourglass_empty</span>Resetowanie...';

    try {
      console.log('=== Form Submit - Starting Password Reset ===');
      console.log('Recovery session set:', recoverySessionSet);
      
      // Ensure we have a recovery session
      if (!recoverySessionSet) {
        console.log('Recovery session not set, trying to get from URL hash...');
        // Try to get from URL hash one more time
        const hashParams = new URLSearchParams(window.location.hash.substring(1));
        const accessToken = hashParams.get('access_token');
        const refreshToken = hashParams.get('refresh_token');
        
        console.log('Tokens from URL:', {
          hasAccessToken: !!accessToken,
          hasRefreshToken: !!refreshToken,
          hashLength: window.location.hash.length
        });
        
        if (!accessToken || !refreshToken) {
          const errorMsg = 'Brak tokena resetowania hasła w URL. Upewnij się, że używasz linku z emaila.';
          console.error('❌', errorMsg);
          console.log('Current URL:', window.location.href);
          throw new Error(errorMsg);
        }
        
        console.log('Setting session from URL tokens...');
        // Set session from URL tokens
        const { data: setSessionData, error: setSessionError } = await supabase.auth.setSession({
          access_token: accessToken,
          refresh_token: refreshToken
        });
        
        if (setSessionError) {
          console.error('❌ Error setting session:', setSessionError);
          throw new Error(`Nie można ustawić sesji z tokena: ${setSessionError.message}`);
        }
        
        if (!setSessionData.session) {
          console.error('❌ Session not set despite no error');
          throw new Error('Nie można ustawić sesji z tokena. Link może być nieprawidłowy lub wygasły.');
        }
        
        console.log('✅ Session set from URL tokens', {
          userId: setSessionData.user?.id,
          hasAccessToken: !!setSessionData.session.access_token
        });
        recoverySessionSet = true;
      }

      // Verify we have a valid session
      console.log('Verifying session...');
      const { data: currentSession, error: sessionError } = await supabase.auth.getSession();
      
      if (sessionError) {
        console.error('❌ Session error:', sessionError);
        throw new Error(`Błąd sesji: ${sessionError.message}`);
      }
      
      if (!currentSession.session) {
        console.error('❌ No session found');
        throw new Error('Brak ważnej sesji resetowania hasła. Upewnij się, że używasz linku z emaila.');
      }
      
      if (!currentSession.session.access_token) {
        console.error('❌ No access token in session');
        throw new Error('Brak tokena dostępu w sesji. Link może być nieprawidłowy lub wygasły.');
      }
      
      console.log('✅ Session verified', {
        userId: currentSession.user?.id,
        email: currentSession.user?.email,
        hasAccessToken: !!currentSession.session.access_token,
        tokenExpiresAt: new Date(currentSession.session.expires_at * 1000).toISOString()
      });

      console.log('Updating password with recovery session...', { 
        userId: currentSession.user?.id,
        hasAccessToken: !!currentSession.session.access_token 
      });
      
      // Update password using Supabase client with recovery session
      // When updating password through a recovery session, Supabase automatically:
      // 1. Updates the password in the database
      // 2. Invalidates all other sessions for this user
      console.log('=== Attempting to update password ===');
      console.log('Password length:', passwordTrimmed.length);
      console.log('Session user ID:', currentSession.user?.id);
      console.log('Session email:', currentSession.user?.email);
      console.log('Has access token:', !!currentSession.session.access_token);
      console.log('Session type (recovery):', currentSession.session.user?.recovery_sent_at ? 'Yes' : 'No');
      
      // IMPORTANT: For password reset with recovery session, we need to ensure
      // the session is properly set as a recovery session before updating
      // Supabase requires the session to be a recovery session to update password
      
      const { data: updateData, error: updateError } = await supabase.auth.updateUser({
        password: passwordTrimmed
      });

      if (updateError) {
        console.error('❌ Password update ERROR:', {
          message: updateError.message,
          status: updateError.status,
          name: updateError.name,
          fullError: updateError
        });
        
        const errorMessage = updateError.message || 'Nie udało się zresetować hasła';
        
        if (errorMessage.includes('session') || errorMessage.includes('token') || errorMessage.includes('expired') || errorMessage.includes('JWT') || errorMessage.includes('Invalid')) {
          showMessage('❌ Link resetowania hasła jest nieprawidłowy lub wygasł. Poproś o nowy link.', true);
        } else if (errorMessage.includes('password') || errorMessage.includes('weak') || errorMessage.includes('strength')) {
          showMessage(`❌ ${errorMessage}. Upewnij się, że hasło spełnia wszystkie wymagania.`, true);
        } else {
          showMessage(`❌ ${errorMessage}`, true);
        }
        return;
      }
      
      console.log('✅ Password update API call successful!', {
        userId: updateData?.user?.id,
        email: updateData?.user?.email,
        hasUser: !!updateData?.user
      });

      // Verify password was actually updated by checking user data
      if (!updateData.user) {
        console.error('❌ Password update failed - no user in response:', updateData);
        throw new Error('Hasło nie zostało zaktualizowane. Spróbuj ponownie.');
      }

      console.log('✅ User data in response:', {
        userId: updateData.user.id,
        email: updateData.user.email,
        updatedAt: updateData.user.updated_at
      });
      
      // Sign out to clear the recovery session and ensure clean state
      // This also helps invalidate any cached sessions
      console.log('Signing out recovery session...');
      const { error: signOutError } = await supabase.auth.signOut();
      if (signOutError) {
        console.warn('Sign out warning (non-critical):', signOutError);
        // Continue anyway - password was updated
      }
      
      // Clear URL hash to remove tokens IMMEDIATELY to prevent reusing the link
      console.log('Clearing URL hash and tokens...');
      window.history.replaceState(null, '', window.location.pathname);
      
      // Clear all Supabase auth data from localStorage
      const keysToRemove = [];
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && (key.includes('supabase') || key.includes('auth') || key.includes('token'))) {
          keysToRemove.push(key);
        }
      }
      keysToRemove.forEach(key => localStorage.removeItem(key));
      
      // DISABLE form to prevent resubmission
      if (form) {
        form.style.pointerEvents = 'none';
        form.style.opacity = '0.6';
      }
      if (submitBtn) {
        submitBtn.disabled = true;
      }
      
      // Show success message - make sure it's visible and prominent
      console.log('✅ Password reset successful! Showing success message...');
      const successMessage = '✅ Hasło zostało pomyślnie zmienione! Możesz się teraz zalogować używając nowego hasła. Przekierowywanie do strony logowania...';
      showMessage(successMessage, false);
      
      // Reset form (but it's disabled so user can't resubmit)
      form.reset();
      
      // Scroll to message to ensure user sees it
      const messageDivElement = document.getElementById('message');
      if (messageDivElement) {
        messageDivElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
        // Make message more prominent
        messageDivElement.style.fontSize = '16px';
        messageDivElement.style.padding = '1.5rem';
        messageDivElement.style.fontWeight = '500';
      }
      
      // Redirect to login with success message after a longer delay (give user time to see message)
      console.log('Will redirect to login page in 5 seconds...');
      setTimeout(() => {
        console.log('Redirecting to login page...');
        window.location.href = '/login?passwordReset=success';
      }, 5000);

    } catch (error) {
      console.error('Reset password error:', error);
      const errorMessage = error instanceof Error ? error.message : 'Nieznany błąd';
      showMessage(`❌ ${errorMessage}`, true);
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = '<span class="material-icons" style="font-size: 18px;">check_circle</span>Ustaw nowe hasło';
    }
    });
  } else {
    console.error('Form not found when adding event listener!');
  }
  
  } // End of initResetPassword function
  
  // Initialize when DOM is ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initResetPassword);
  } else {
    // DOM is already ready
    initResetPassword();
  }
</script>
